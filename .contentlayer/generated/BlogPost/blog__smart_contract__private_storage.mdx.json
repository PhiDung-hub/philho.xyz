{
  "title": "Not so private Solidity storage",
  "date": "2023-05-09T00:00:00Z",
  "modifiedTime": "2023-05-09T00:00:00Z",
  "summary": "Introduce private storage vulnerability. A mockup exploitation and potential solutions.",
  "image": "blogs/blockchain/private_storage/cover.webp",
  "body": {
    "raw": "\n# Problem introduction\n\nIn Solidity, you can define private variables in a contract to keep them hidden from other contracts.\nPrivate variables are only accessible within the contract in which they are defined and cannot be accessed\nor modified by other contracts or external users. This behavior is expected from programming languages which support OOP paradigm.\n\nHowever, it's important to note that private variables are still visible to all participants on the blockchain, including miners and nodes.\nThis means that the values of private variables are not completely hidden,\nand should not be used to store sensitive information such as passwords or private keys.\n\n# An example\n\nWe will showcase an exploitation example in Foundry-VM.\n\n## The Locker contract\n\nLet's defined a `Locker` contract with 16bytes `secretKey` as below:\n\n```solidity\n// SPDX-License-Identifier: MIT\npragma solidity ^0.8.13;\n\ncontract Locker {\n  bool public locked = true; // 1 bytes\n  bytes16 private secretKey; // 16 bytes\n\n  constructor(bytes16 _secretKey) {\n    secretKey = _secretKey;\n  }\n\n  function unlock(bytes16 _key) public {\n    require(_key == bytes16(secretKey));\n    locked = false;\n  }\n}\n\n```\n\n## Unlock\n\nIf we analyze [storage allocation](https://ethereum.org/en/developers/docs/smart-contracts/anatomy/#data) of the contract above, the result is:\n\n<Image src=\"/blogs/blockchain/private_storage/storage.webp\" width=\"1200\" height=\"500\" caption=\"Storage layout of Locker contract\" />\n\nHaving that information in hand, an example unlocker would perform the following step:\n\n1. Inspect the target contract\n2. Load from contract storage slot 0\n3. Extract `secretKey = bytes[15..30]` from the storage\n4. Use the secret key to unlock.\n\nAn example mockup is implemented as follows:\n\n```solidity\npragma solidity ^0.8.13;\n\nimport \"forge-std/Test.sol\";\nimport \"~/private_lock/Locker.sol\"; // the defined Locker contract\n\ncontract LockerTest is Test {\n  Locker public targetLocker;\n\n  function setUp() public {\n    bytes16 secretPhrase = bytes16(keccak256(abi.encodePacked(tx.origin, \"SECRET_HASH\")));\n    targetLocker = new Locker(secretPhrase);\n  }\n\n  function breakSecret(Locker _targetLocker) internal view returns (bytes16) {\n    // Step 1: Identify the contract\n    address lockerAddress = address(_targetLocker);\n    // Step 2: Retrieve storage data from at block 0 from the smart contract\n    bytes32 secretDataBlock = vm.load(lockerAddress, bytes32(uint256(0)));\n\n    // LAYOUT: 15 \"0\" | 16 (secretKey) | 1 (\"locked\" status) [SLOT 0]\n    // Step 3: Retrieve byte 16th to 31th, which is the secret key.\n    bytes16 secretKey = bytes16(secretDataBlock << (15 * 8));\n\n    return secretKey;\n  }\n\n  function testUnlockLocker() public {\n    // Step 4: Unlock\n    bytes16 secretKey = breakSecret(targetLocker);\n    targetLocker.unlock(secretKey);\n\n    bool isUnlocked = !targetLocker.locked();\n    assertTrue(isUnlocked, \"Hacker should break the lock\");\n  }\n}\n```\n\n# Prevention\n\nA simple solution to make the contract more secured is using a pre-defined signature as the secret key.\nFor this example, I use elliptic curve DSA:\n\n```solidity\n// SPDX-License-Identifier: MIT\npragma solidity ^0.8.13;\n\nimport \"@openzeppelin/contracts/utils/cryptography/ECDSA.sol\";\n\ncontract SecureLocker {\n  bool public locked = true; // 1 bytes\n  address private owner;\n  using ECDSA for bytes32;\n\n  constructor(address _owner) {\n    owner = _owner;\n  }\n\n  function unlock(bytes memory _signature) public {\n    // EIP 712 Signature Validation: https://eips.ethereum.org/EIPS/eip-712\n    bytes memory eth_msg = abi.encodePacked(\"\\x19Ethereum Signed Message:\\n20\", \"<SECRET_OFFCHAIN_MSG>\");\n    bytes32 hash = keccak256(eth_msg);\n    if (owner == hash.recover(_signature)) {\n      locked = false;\n    }\n  }\n}\n```\n\nWith this setup, the contract owner will store their signature (secret key) offchain and use it on `unlock` calls.\n\n# References\n\n1. [Ethernaut Level 12](https://ethernaut.openzeppelin.com/404)\n2. [Ethereum storage layout](https://ethereum.org/en/developers/docs/smart-contracts/anatomy/#data)\n3. [Ethereum OpCodes](https://ethereum.org/en/developers/docs/evm/opcodes/)\n",
    "code": "var Component=(()=>{var sr=Object.create;var A=Object.defineProperty;var lr=Object.getOwnPropertyDescriptor;var dr=Object.getOwnPropertyNames;var ur=Object.getPrototypeOf,fr=Object.prototype.hasOwnProperty;var H=(l,n)=>()=>(n||l((n={exports:{}}).exports,n),n.exports),mr=(l,n)=>{for(var m in n)A(l,m,{get:n[m],enumerable:!0})},xe=(l,n,m,y)=>{if(n&&typeof n==\"object\"||typeof n==\"function\")for(let g of dr(n))!fr.call(l,g)&&g!==m&&A(l,g,{get:()=>n[g],enumerable:!(y=lr(n,g))||y.enumerable});return l};var _r=(l,n,m)=>(m=l!=null?sr(ur(l)):{},xe(n||!l||!l.__esModule?A(m,\"default\",{value:l,enumerable:!0}):m,l)),pr=l=>xe(A({},\"__esModule\",{value:!0}),l);var we=H((Nr,Ne)=>{Ne.exports=React});var Ee=H(z=>{\"use strict\";(function(){\"use strict\";var l=we(),n=Symbol.for(\"react.element\"),m=Symbol.for(\"react.portal\"),y=Symbol.for(\"react.fragment\"),g=Symbol.for(\"react.strict_mode\"),G=Symbol.for(\"react.profiler\"),X=Symbol.for(\"react.provider\"),q=Symbol.for(\"react.context\"),R=Symbol.for(\"react.forward_ref\"),L=Symbol.for(\"react.suspense\"),F=Symbol.for(\"react.suspense_list\"),T=Symbol.for(\"react.memo\"),I=Symbol.for(\"react.lazy\"),Te=Symbol.for(\"react.offscreen\"),Z=Symbol.iterator,Se=\"@@iterator\";function Pe(e){if(e===null||typeof e!=\"object\")return null;var r=Z&&e[Z]||e[Se];return typeof r==\"function\"?r:null}var N=l.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED;function _(e){{for(var r=arguments.length,t=new Array(r>1?r-1:0),a=1;a<r;a++)t[a-1]=arguments[a];Ce(\"error\",e,t)}}function Ce(e,r,t){{var a=N.ReactDebugCurrentFrame,s=a.getStackAddendum();s!==\"\"&&(r+=\"%s\",t=t.concat([s]));var d=t.map(function(c){return String(c)});d.unshift(\"Warning: \"+r),Function.prototype.apply.call(console[e],console,d)}}var Oe=!1,De=!1,Ae=!1,Le=!1,Fe=!1,J;J=Symbol.for(\"react.module.reference\");function Ie(e){return!!(typeof e==\"string\"||typeof e==\"function\"||e===y||e===G||Fe||e===g||e===L||e===F||Le||e===Te||Oe||De||Ae||typeof e==\"object\"&&e!==null&&(e.$$typeof===I||e.$$typeof===T||e.$$typeof===X||e.$$typeof===q||e.$$typeof===R||e.$$typeof===J||e.getModuleId!==void 0))}function Me(e,r,t){var a=e.displayName;if(a)return a;var s=r.displayName||r.name||\"\";return s!==\"\"?t+\"(\"+s+\")\":t}function Q(e){return e.displayName||\"Context\"}function h(e){if(e==null)return null;if(typeof e.tag==\"number\"&&_(\"Received an unexpected object in getComponentNameFromType(). This is likely a bug in React. Please file an issue.\"),typeof e==\"function\")return e.displayName||e.name||null;if(typeof e==\"string\")return e;switch(e){case y:return\"Fragment\";case m:return\"Portal\";case G:return\"Profiler\";case g:return\"StrictMode\";case L:return\"Suspense\";case F:return\"SuspenseList\"}if(typeof e==\"object\")switch(e.$$typeof){case q:var r=e;return Q(r)+\".Consumer\";case X:var t=e;return Q(t._context)+\".Provider\";case R:return Me(e,e.render,\"ForwardRef\");case T:var a=e.displayName||null;return a!==null?a:h(e.type)||\"Memo\";case I:{var s=e,d=s._payload,c=s._init;try{return h(c(d))}catch{return null}}}return null}var x=Object.assign,k=0,ee,re,te,ne,ae,oe,ie;function ce(){}ce.__reactDisabledLog=!0;function We(){{if(k===0){ee=console.log,re=console.info,te=console.warn,ne=console.error,ae=console.group,oe=console.groupCollapsed,ie=console.groupEnd;var e={configurable:!0,enumerable:!0,value:ce,writable:!0};Object.defineProperties(console,{info:e,log:e,warn:e,error:e,group:e,groupCollapsed:e,groupEnd:e})}k++}}function Ye(){{if(k--,k===0){var e={configurable:!0,enumerable:!0,writable:!0};Object.defineProperties(console,{log:x({},e,{value:ee}),info:x({},e,{value:re}),warn:x({},e,{value:te}),error:x({},e,{value:ne}),group:x({},e,{value:ae}),groupCollapsed:x({},e,{value:oe}),groupEnd:x({},e,{value:ie})})}k<0&&_(\"disabledDepth fell below zero. This is a bug in React. Please file an issue.\")}}var M=N.ReactCurrentDispatcher,W;function S(e,r,t){{if(W===void 0)try{throw Error()}catch(s){var a=s.stack.trim().match(/\\n( *(at )?)/);W=a&&a[1]||\"\"}return`\n`+W+e}}var Y=!1,P;{var Ue=typeof WeakMap==\"function\"?WeakMap:Map;P=new Ue}function se(e,r){if(!e||Y)return\"\";{var t=P.get(e);if(t!==void 0)return t}var a;Y=!0;var s=Error.prepareStackTrace;Error.prepareStackTrace=void 0;var d;d=M.current,M.current=null,We();try{if(r){var c=function(){throw Error()};if(Object.defineProperty(c.prototype,\"props\",{set:function(){throw Error()}}),typeof Reflect==\"object\"&&Reflect.construct){try{Reflect.construct(c,[])}catch(v){a=v}Reflect.construct(e,[],c)}else{try{c.call()}catch(v){a=v}e.call(c.prototype)}}else{try{throw Error()}catch(v){a=v}e()}}catch(v){if(v&&a&&typeof v.stack==\"string\"){for(var i=v.stack.split(`\n`),p=a.stack.split(`\n`),u=i.length-1,f=p.length-1;u>=1&&f>=0&&i[u]!==p[f];)f--;for(;u>=1&&f>=0;u--,f--)if(i[u]!==p[f]){if(u!==1||f!==1)do if(u--,f--,f<0||i[u]!==p[f]){var b=`\n`+i[u].replace(\" at new \",\" at \");return e.displayName&&b.includes(\"<anonymous>\")&&(b=b.replace(\"<anonymous>\",e.displayName)),typeof e==\"function\"&&P.set(e,b),b}while(u>=1&&f>=0);break}}}finally{Y=!1,M.current=d,Ye(),Error.prepareStackTrace=s}var E=e?e.displayName||e.name:\"\",ye=E?S(E):\"\";return typeof e==\"function\"&&P.set(e,ye),ye}function $e(e,r,t){return se(e,!1)}function Ve(e){var r=e.prototype;return!!(r&&r.isReactComponent)}function C(e,r,t){if(e==null)return\"\";if(typeof e==\"function\")return se(e,Ve(e));if(typeof e==\"string\")return S(e);switch(e){case L:return S(\"Suspense\");case F:return S(\"SuspenseList\")}if(typeof e==\"object\")switch(e.$$typeof){case R:return $e(e.render);case T:return C(e.type,r,t);case I:{var a=e,s=a._payload,d=a._init;try{return C(d(s),r,t)}catch{}}}return\"\"}var O=Object.prototype.hasOwnProperty,le={},de=N.ReactDebugCurrentFrame;function D(e){if(e){var r=e._owner,t=C(e.type,e._source,r?r.type:null);de.setExtraStackFrame(t)}else de.setExtraStackFrame(null)}function Ke(e,r,t,a,s){{var d=Function.call.bind(O);for(var c in e)if(d(e,c)){var i=void 0;try{if(typeof e[c]!=\"function\"){var p=Error((a||\"React class\")+\": \"+t+\" type `\"+c+\"` is invalid; it must be a function, usually from the `prop-types` package, but received `\"+typeof e[c]+\"`.This often happens because of typos such as `PropTypes.function` instead of `PropTypes.func`.\");throw p.name=\"Invariant Violation\",p}i=e[c](r,c,a,t,null,\"SECRET_DO_NOT_PASS_THIS_OR_YOU_WILL_BE_FIRED\")}catch(u){i=u}i&&!(i instanceof Error)&&(D(s),_(\"%s: type specification of %s `%s` is invalid; the type checker function must return `null` or an `Error` but returned a %s. You may have forgotten to pass an argument to the type checker creator (arrayOf, instanceOf, objectOf, oneOf, oneOfType, and shape all require an argument).\",a||\"React class\",t,c,typeof i),D(null)),i instanceof Error&&!(i.message in le)&&(le[i.message]=!0,D(s),_(\"Failed %s type: %s\",t,i.message),D(null))}}}var Be=Array.isArray;function U(e){return Be(e)}function He(e){{var r=typeof Symbol==\"function\"&&Symbol.toStringTag,t=r&&e[Symbol.toStringTag]||e.constructor.name||\"Object\";return t}}function ze(e){try{return ue(e),!1}catch{return!0}}function ue(e){return\"\"+e}function fe(e){if(ze(e))return _(\"The provided key is an unsupported type %s. This value must be coerced to a string before before using it here.\",He(e)),ue(e)}var j=N.ReactCurrentOwner,Ge={key:!0,ref:!0,__self:!0,__source:!0},me,_e,$;$={};function Xe(e){if(O.call(e,\"ref\")){var r=Object.getOwnPropertyDescriptor(e,\"ref\").get;if(r&&r.isReactWarning)return!1}return e.ref!==void 0}function qe(e){if(O.call(e,\"key\")){var r=Object.getOwnPropertyDescriptor(e,\"key\").get;if(r&&r.isReactWarning)return!1}return e.key!==void 0}function Ze(e,r){if(typeof e.ref==\"string\"&&j.current&&r&&j.current.stateNode!==r){var t=h(j.current.type);$[t]||(_('Component \"%s\" contains the string ref \"%s\". Support for string refs will be removed in a future major release. This case cannot be automatically converted to an arrow function. We ask you to manually fix this case by using useRef() or createRef() instead. Learn more about using refs safely here: https://reactjs.org/link/strict-mode-string-ref',h(j.current.type),e.ref),$[t]=!0)}}function Je(e,r){{var t=function(){me||(me=!0,_(\"%s: `key` is not a prop. Trying to access it will result in `undefined` being returned. If you need to access the same value within the child component, you should pass it as a different prop. (https://reactjs.org/link/special-props)\",r))};t.isReactWarning=!0,Object.defineProperty(e,\"key\",{get:t,configurable:!0})}}function Qe(e,r){{var t=function(){_e||(_e=!0,_(\"%s: `ref` is not a prop. Trying to access it will result in `undefined` being returned. If you need to access the same value within the child component, you should pass it as a different prop. (https://reactjs.org/link/special-props)\",r))};t.isReactWarning=!0,Object.defineProperty(e,\"ref\",{get:t,configurable:!0})}}var er=function(e,r,t,a,s,d,c){var i={$$typeof:n,type:e,key:r,ref:t,props:c,_owner:d};return i._store={},Object.defineProperty(i._store,\"validated\",{configurable:!1,enumerable:!1,writable:!0,value:!1}),Object.defineProperty(i,\"_self\",{configurable:!1,enumerable:!1,writable:!1,value:a}),Object.defineProperty(i,\"_source\",{configurable:!1,enumerable:!1,writable:!1,value:s}),Object.freeze&&(Object.freeze(i.props),Object.freeze(i)),i};function rr(e,r,t,a,s){{var d,c={},i=null,p=null;t!==void 0&&(fe(t),i=\"\"+t),qe(r)&&(fe(r.key),i=\"\"+r.key),Xe(r)&&(p=r.ref,Ze(r,s));for(d in r)O.call(r,d)&&!Ge.hasOwnProperty(d)&&(c[d]=r[d]);if(e&&e.defaultProps){var u=e.defaultProps;for(d in u)c[d]===void 0&&(c[d]=u[d])}if(i||p){var f=typeof e==\"function\"?e.displayName||e.name||\"Unknown\":e;i&&Je(c,f),p&&Qe(c,f)}return er(e,i,p,s,a,j.current,c)}}var V=N.ReactCurrentOwner,pe=N.ReactDebugCurrentFrame;function w(e){if(e){var r=e._owner,t=C(e.type,e._source,r?r.type:null);pe.setExtraStackFrame(t)}else pe.setExtraStackFrame(null)}var K;K=!1;function B(e){return typeof e==\"object\"&&e!==null&&e.$$typeof===n}function be(){{if(V.current){var e=h(V.current.type);if(e)return`\n\nCheck the render method of \\``+e+\"`.\"}return\"\"}}function tr(e){{if(e!==void 0){var r=e.fileName.replace(/^.*[\\\\\\/]/,\"\"),t=e.lineNumber;return`\n\nCheck your code at `+r+\":\"+t+\".\"}return\"\"}}var he={};function nr(e){{var r=be();if(!r){var t=typeof e==\"string\"?e:e.displayName||e.name;t&&(r=`\n\nCheck the top-level render call using <`+t+\">.\")}return r}}function ve(e,r){{if(!e._store||e._store.validated||e.key!=null)return;e._store.validated=!0;var t=nr(r);if(he[t])return;he[t]=!0;var a=\"\";e&&e._owner&&e._owner!==V.current&&(a=\" It was passed a child from \"+h(e._owner.type)+\".\"),w(e),_('Each child in a list should have a unique \"key\" prop.%s%s See https://reactjs.org/link/warning-keys for more information.',t,a),w(null)}}function ge(e,r){{if(typeof e!=\"object\")return;if(U(e))for(var t=0;t<e.length;t++){var a=e[t];B(a)&&ve(a,r)}else if(B(e))e._store&&(e._store.validated=!0);else if(e){var s=Pe(e);if(typeof s==\"function\"&&s!==e.entries)for(var d=s.call(e),c;!(c=d.next()).done;)B(c.value)&&ve(c.value,r)}}}function ar(e){{var r=e.type;if(r==null||typeof r==\"string\")return;var t;if(typeof r==\"function\")t=r.propTypes;else if(typeof r==\"object\"&&(r.$$typeof===R||r.$$typeof===T))t=r.propTypes;else return;if(t){var a=h(r);Ke(t,e.props,\"prop\",a,e)}else if(r.PropTypes!==void 0&&!K){K=!0;var s=h(r);_(\"Component %s declared `PropTypes` instead of `propTypes`. Did you misspell the property assignment?\",s||\"Unknown\")}typeof r.getDefaultProps==\"function\"&&!r.getDefaultProps.isReactClassApproved&&_(\"getDefaultProps is only used on classic React.createClass definitions. Use a static property named `defaultProps` instead.\")}}function or(e){{for(var r=Object.keys(e.props),t=0;t<r.length;t++){var a=r[t];if(a!==\"children\"&&a!==\"key\"){w(e),_(\"Invalid prop `%s` supplied to `React.Fragment`. React.Fragment can only have `key` and `children` props.\",a),w(null);break}}e.ref!==null&&(w(e),_(\"Invalid attribute `ref` supplied to `React.Fragment`.\"),w(null))}}function ir(e,r,t,a,s,d){{var c=Ie(e);if(!c){var i=\"\";(e===void 0||typeof e==\"object\"&&e!==null&&Object.keys(e).length===0)&&(i+=\" You likely forgot to export your component from the file it's defined in, or you might have mixed up default and named imports.\");var p=tr(s);p?i+=p:i+=be();var u;e===null?u=\"null\":U(e)?u=\"array\":e!==void 0&&e.$$typeof===n?(u=\"<\"+(h(e.type)||\"Unknown\")+\" />\",i=\" Did you accidentally export a JSX literal instead of a component?\"):u=typeof e,_(\"React.jsx: type is invalid -- expected a string (for built-in components) or a class/function (for composite components) but got: %s.%s\",u,i)}var f=rr(e,r,t,s,d);if(f==null)return f;if(c){var b=r.children;if(b!==void 0)if(a)if(U(b)){for(var E=0;E<b.length;E++)ge(b[E],e);Object.freeze&&Object.freeze(b)}else _(\"React.jsx: Static children should always be an array. You are likely explicitly calling React.jsxs or React.jsxDEV. Use the Babel transform instead.\");else ge(b,e)}return e===y?or(f):ar(f),f}}var cr=ir;z.Fragment=y,z.jsxDEV=cr})()});var je=H((Er,ke)=>{\"use strict\";ke.exports=Ee()});var yr={};mr(yr,{default:()=>vr,frontmatter:()=>br});var o=_r(je()),br={title:\"Not so private Solidity storage\",date:\"2023-05-09T00:00:00Z\",modifiedTime:\"2023-05-09T00:00:00Z\",summary:\"Introduce private storage vulnerability. A mockup exploitation and potential solutions.\",image:\"blogs/blockchain/private_storage/cover.webp\",type:\"BlogPost\"};function Re(l){let n=Object.assign({h1:\"h1\",p:\"p\",h2:\"h2\",code:\"code\",pre:\"pre\",a:\"a\",ol:\"ol\",li:\"li\"},l.components),{Image:m}=n;return m||gr(\"Image\",!0,\"52:1-52:133\"),(0,o.jsxDEV)(o.Fragment,{children:[(0,o.jsxDEV)(n.h1,{children:\"Problem introduction\"},void 0,!1,{fileName:\"/home/phi/side_projects/personal-website/mdx_contents/blog/smart_contract/_mdx_bundler_entry_point-d7acae44-c670-4980-9519-52e7cf9adfed.mdx\",lineNumber:10,columnNumber:1},this),`\n`,(0,o.jsxDEV)(n.p,{children:`In Solidity, you can define private variables in a contract to keep them hidden from other contracts.\nPrivate variables are only accessible within the contract in which they are defined and cannot be accessed\nor modified by other contracts or external users. This behavior is expected from programming languages which support OOP paradigm.`},void 0,!1,{fileName:\"/home/phi/side_projects/personal-website/mdx_contents/blog/smart_contract/_mdx_bundler_entry_point-d7acae44-c670-4980-9519-52e7cf9adfed.mdx\",lineNumber:12,columnNumber:1},this),`\n`,(0,o.jsxDEV)(n.p,{children:`However, it's important to note that private variables are still visible to all participants on the blockchain, including miners and nodes.\nThis means that the values of private variables are not completely hidden,\nand should not be used to store sensitive information such as passwords or private keys.`},void 0,!1,{fileName:\"/home/phi/side_projects/personal-website/mdx_contents/blog/smart_contract/_mdx_bundler_entry_point-d7acae44-c670-4980-9519-52e7cf9adfed.mdx\",lineNumber:16,columnNumber:1},this),`\n`,(0,o.jsxDEV)(n.h1,{children:\"An example\"},void 0,!1,{fileName:\"/home/phi/side_projects/personal-website/mdx_contents/blog/smart_contract/_mdx_bundler_entry_point-d7acae44-c670-4980-9519-52e7cf9adfed.mdx\",lineNumber:20,columnNumber:1},this),`\n`,(0,o.jsxDEV)(n.p,{children:\"We will showcase an exploitation example in Foundry-VM.\"},void 0,!1,{fileName:\"/home/phi/side_projects/personal-website/mdx_contents/blog/smart_contract/_mdx_bundler_entry_point-d7acae44-c670-4980-9519-52e7cf9adfed.mdx\",lineNumber:22,columnNumber:1},this),`\n`,(0,o.jsxDEV)(n.h2,{children:\"The Locker contract\"},void 0,!1,{fileName:\"/home/phi/side_projects/personal-website/mdx_contents/blog/smart_contract/_mdx_bundler_entry_point-d7acae44-c670-4980-9519-52e7cf9adfed.mdx\",lineNumber:24,columnNumber:1},this),`\n`,(0,o.jsxDEV)(n.p,{children:[\"Let's defined a \",(0,o.jsxDEV)(n.code,{children:\"Locker\"},void 0,!1,{fileName:\"/home/phi/side_projects/personal-website/mdx_contents/blog/smart_contract/_mdx_bundler_entry_point-d7acae44-c670-4980-9519-52e7cf9adfed.mdx\",lineNumber:26,columnNumber:17},this),\" contract with 16bytes \",(0,o.jsxDEV)(n.code,{children:\"secretKey\"},void 0,!1,{fileName:\"/home/phi/side_projects/personal-website/mdx_contents/blog/smart_contract/_mdx_bundler_entry_point-d7acae44-c670-4980-9519-52e7cf9adfed.mdx\",lineNumber:26,columnNumber:48},this),\" as below:\"]},void 0,!0,{fileName:\"/home/phi/side_projects/personal-website/mdx_contents/blog/smart_contract/_mdx_bundler_entry_point-d7acae44-c670-4980-9519-52e7cf9adfed.mdx\",lineNumber:26,columnNumber:1},this),`\n`,(0,o.jsxDEV)(n.pre,{children:(0,o.jsxDEV)(n.code,{className:\"language-solidity\",children:`// SPDX-License-Identifier: MIT\npragma solidity ^0.8.13;\n\ncontract Locker {\n  bool public locked = true; // 1 bytes\n  bytes16 private secretKey; // 16 bytes\n\n  constructor(bytes16 _secretKey) {\n    secretKey = _secretKey;\n  }\n\n  function unlock(bytes16 _key) public {\n    require(_key == bytes16(secretKey));\n    locked = false;\n  }\n}\n\n`},void 0,!1,{fileName:\"/home/phi/side_projects/personal-website/mdx_contents/blog/smart_contract/_mdx_bundler_entry_point-d7acae44-c670-4980-9519-52e7cf9adfed.mdx\",lineNumber:28,columnNumber:1},this)},void 0,!1,{fileName:\"/home/phi/side_projects/personal-website/mdx_contents/blog/smart_contract/_mdx_bundler_entry_point-d7acae44-c670-4980-9519-52e7cf9adfed.mdx\",lineNumber:28,columnNumber:1},this),`\n`,(0,o.jsxDEV)(n.h2,{children:\"Unlock\"},void 0,!1,{fileName:\"/home/phi/side_projects/personal-website/mdx_contents/blog/smart_contract/_mdx_bundler_entry_point-d7acae44-c670-4980-9519-52e7cf9adfed.mdx\",lineNumber:48,columnNumber:1},this),`\n`,(0,o.jsxDEV)(n.p,{children:[\"If we analyze \",(0,o.jsxDEV)(n.a,{href:\"https://ethereum.org/en/developers/docs/smart-contracts/anatomy/#data\",children:\"storage allocation\"},void 0,!1,{fileName:\"/home/phi/side_projects/personal-website/mdx_contents/blog/smart_contract/_mdx_bundler_entry_point-d7acae44-c670-4980-9519-52e7cf9adfed.mdx\",lineNumber:50,columnNumber:15},this),\" of the contract above, the result is:\"]},void 0,!0,{fileName:\"/home/phi/side_projects/personal-website/mdx_contents/blog/smart_contract/_mdx_bundler_entry_point-d7acae44-c670-4980-9519-52e7cf9adfed.mdx\",lineNumber:50,columnNumber:1},this),`\n`,(0,o.jsxDEV)(m,{src:\"/blogs/blockchain/private_storage/storage.webp\",width:\"1200\",height:\"500\",caption:\"Storage layout of Locker contract\"},void 0,!1,{fileName:\"/home/phi/side_projects/personal-website/mdx_contents/blog/smart_contract/_mdx_bundler_entry_point-d7acae44-c670-4980-9519-52e7cf9adfed.mdx\",lineNumber:52,columnNumber:1},this),`\n`,(0,o.jsxDEV)(n.p,{children:\"Having that information in hand, an example unlocker would perform the following step:\"},void 0,!1,{fileName:\"/home/phi/side_projects/personal-website/mdx_contents/blog/smart_contract/_mdx_bundler_entry_point-d7acae44-c670-4980-9519-52e7cf9adfed.mdx\",lineNumber:54,columnNumber:1},this),`\n`,(0,o.jsxDEV)(n.ol,{children:[`\n`,(0,o.jsxDEV)(n.li,{children:\"Inspect the target contract\"},void 0,!1,{fileName:\"/home/phi/side_projects/personal-website/mdx_contents/blog/smart_contract/_mdx_bundler_entry_point-d7acae44-c670-4980-9519-52e7cf9adfed.mdx\",lineNumber:56,columnNumber:1},this),`\n`,(0,o.jsxDEV)(n.li,{children:\"Load from contract storage slot 0\"},void 0,!1,{fileName:\"/home/phi/side_projects/personal-website/mdx_contents/blog/smart_contract/_mdx_bundler_entry_point-d7acae44-c670-4980-9519-52e7cf9adfed.mdx\",lineNumber:57,columnNumber:1},this),`\n`,(0,o.jsxDEV)(n.li,{children:[\"Extract \",(0,o.jsxDEV)(n.code,{children:\"secretKey = bytes[15..30]\"},void 0,!1,{fileName:\"/home/phi/side_projects/personal-website/mdx_contents/blog/smart_contract/_mdx_bundler_entry_point-d7acae44-c670-4980-9519-52e7cf9adfed.mdx\",lineNumber:58,columnNumber:12},this),\" from the storage\"]},void 0,!0,{fileName:\"/home/phi/side_projects/personal-website/mdx_contents/blog/smart_contract/_mdx_bundler_entry_point-d7acae44-c670-4980-9519-52e7cf9adfed.mdx\",lineNumber:58,columnNumber:1},this),`\n`,(0,o.jsxDEV)(n.li,{children:\"Use the secret key to unlock.\"},void 0,!1,{fileName:\"/home/phi/side_projects/personal-website/mdx_contents/blog/smart_contract/_mdx_bundler_entry_point-d7acae44-c670-4980-9519-52e7cf9adfed.mdx\",lineNumber:59,columnNumber:1},this),`\n`]},void 0,!0,{fileName:\"/home/phi/side_projects/personal-website/mdx_contents/blog/smart_contract/_mdx_bundler_entry_point-d7acae44-c670-4980-9519-52e7cf9adfed.mdx\",lineNumber:56,columnNumber:1},this),`\n`,(0,o.jsxDEV)(n.p,{children:\"An example mockup is implemented as follows:\"},void 0,!1,{fileName:\"/home/phi/side_projects/personal-website/mdx_contents/blog/smart_contract/_mdx_bundler_entry_point-d7acae44-c670-4980-9519-52e7cf9adfed.mdx\",lineNumber:61,columnNumber:1},this),`\n`,(0,o.jsxDEV)(n.pre,{children:(0,o.jsxDEV)(n.code,{className:\"language-solidity\",children:`pragma solidity ^0.8.13;\n\nimport \"forge-std/Test.sol\";\nimport \"~/private_lock/Locker.sol\"; // the defined Locker contract\n\ncontract LockerTest is Test {\n  Locker public targetLocker;\n\n  function setUp() public {\n    bytes16 secretPhrase = bytes16(keccak256(abi.encodePacked(tx.origin, \"SECRET_HASH\")));\n    targetLocker = new Locker(secretPhrase);\n  }\n\n  function breakSecret(Locker _targetLocker) internal view returns (bytes16) {\n    // Step 1: Identify the contract\n    address lockerAddress = address(_targetLocker);\n    // Step 2: Retrieve storage data from at block 0 from the smart contract\n    bytes32 secretDataBlock = vm.load(lockerAddress, bytes32(uint256(0)));\n\n    // LAYOUT: 15 \"0\" | 16 (secretKey) | 1 (\"locked\" status) [SLOT 0]\n    // Step 3: Retrieve byte 16th to 31th, which is the secret key.\n    bytes16 secretKey = bytes16(secretDataBlock << (15 * 8));\n\n    return secretKey;\n  }\n\n  function testUnlockLocker() public {\n    // Step 4: Unlock\n    bytes16 secretKey = breakSecret(targetLocker);\n    targetLocker.unlock(secretKey);\n\n    bool isUnlocked = !targetLocker.locked();\n    assertTrue(isUnlocked, \"Hacker should break the lock\");\n  }\n}\n`},void 0,!1,{fileName:\"/home/phi/side_projects/personal-website/mdx_contents/blog/smart_contract/_mdx_bundler_entry_point-d7acae44-c670-4980-9519-52e7cf9adfed.mdx\",lineNumber:63,columnNumber:1},this)},void 0,!1,{fileName:\"/home/phi/side_projects/personal-website/mdx_contents/blog/smart_contract/_mdx_bundler_entry_point-d7acae44-c670-4980-9519-52e7cf9adfed.mdx\",lineNumber:63,columnNumber:1},this),`\n`,(0,o.jsxDEV)(n.h1,{children:\"Prevention\"},void 0,!1,{fileName:\"/home/phi/side_projects/personal-website/mdx_contents/blog/smart_contract/_mdx_bundler_entry_point-d7acae44-c670-4980-9519-52e7cf9adfed.mdx\",lineNumber:101,columnNumber:1},this),`\n`,(0,o.jsxDEV)(n.p,{children:`A simple solution to make the contract more secured is using a pre-defined signature as the secret key.\nFor this example, I use elliptic curve DSA:`},void 0,!1,{fileName:\"/home/phi/side_projects/personal-website/mdx_contents/blog/smart_contract/_mdx_bundler_entry_point-d7acae44-c670-4980-9519-52e7cf9adfed.mdx\",lineNumber:103,columnNumber:1},this),`\n`,(0,o.jsxDEV)(n.pre,{children:(0,o.jsxDEV)(n.code,{className:\"language-solidity\",children:`// SPDX-License-Identifier: MIT\npragma solidity ^0.8.13;\n\nimport \"@openzeppelin/contracts/utils/cryptography/ECDSA.sol\";\n\ncontract SecureLocker {\n  bool public locked = true; // 1 bytes\n  address private owner;\n  using ECDSA for bytes32;\n\n  constructor(address _owner) {\n    owner = _owner;\n  }\n\n  function unlock(bytes memory _signature) public {\n    // EIP 712 Signature Validation: https://eips.ethereum.org/EIPS/eip-712\n    bytes memory eth_msg = abi.encodePacked(\"\\\\x19Ethereum Signed Message:\\\\n20\", \"<SECRET_OFFCHAIN_MSG>\");\n    bytes32 hash = keccak256(eth_msg);\n    if (owner == hash.recover(_signature)) {\n      locked = false;\n    }\n  }\n}\n`},void 0,!1,{fileName:\"/home/phi/side_projects/personal-website/mdx_contents/blog/smart_contract/_mdx_bundler_entry_point-d7acae44-c670-4980-9519-52e7cf9adfed.mdx\",lineNumber:106,columnNumber:1},this)},void 0,!1,{fileName:\"/home/phi/side_projects/personal-website/mdx_contents/blog/smart_contract/_mdx_bundler_entry_point-d7acae44-c670-4980-9519-52e7cf9adfed.mdx\",lineNumber:106,columnNumber:1},this),`\n`,(0,o.jsxDEV)(n.p,{children:[\"With this setup, the contract owner will store their signature (secret key) offchain and use it on \",(0,o.jsxDEV)(n.code,{children:\"unlock\"},void 0,!1,{fileName:\"/home/phi/side_projects/personal-website/mdx_contents/blog/smart_contract/_mdx_bundler_entry_point-d7acae44-c670-4980-9519-52e7cf9adfed.mdx\",lineNumber:132,columnNumber:100},this),\" calls.\"]},void 0,!0,{fileName:\"/home/phi/side_projects/personal-website/mdx_contents/blog/smart_contract/_mdx_bundler_entry_point-d7acae44-c670-4980-9519-52e7cf9adfed.mdx\",lineNumber:132,columnNumber:1},this),`\n`,(0,o.jsxDEV)(n.h1,{children:\"References\"},void 0,!1,{fileName:\"/home/phi/side_projects/personal-website/mdx_contents/blog/smart_contract/_mdx_bundler_entry_point-d7acae44-c670-4980-9519-52e7cf9adfed.mdx\",lineNumber:134,columnNumber:1},this),`\n`,(0,o.jsxDEV)(n.ol,{children:[`\n`,(0,o.jsxDEV)(n.li,{children:(0,o.jsxDEV)(n.a,{href:\"https://ethernaut.openzeppelin.com/404\",children:\"Ethernaut Level 12\"},void 0,!1,{fileName:\"/home/phi/side_projects/personal-website/mdx_contents/blog/smart_contract/_mdx_bundler_entry_point-d7acae44-c670-4980-9519-52e7cf9adfed.mdx\",lineNumber:136,columnNumber:4},this)},void 0,!1,{fileName:\"/home/phi/side_projects/personal-website/mdx_contents/blog/smart_contract/_mdx_bundler_entry_point-d7acae44-c670-4980-9519-52e7cf9adfed.mdx\",lineNumber:136,columnNumber:1},this),`\n`,(0,o.jsxDEV)(n.li,{children:(0,o.jsxDEV)(n.a,{href:\"https://ethereum.org/en/developers/docs/smart-contracts/anatomy/#data\",children:\"Ethereum storage layout\"},void 0,!1,{fileName:\"/home/phi/side_projects/personal-website/mdx_contents/blog/smart_contract/_mdx_bundler_entry_point-d7acae44-c670-4980-9519-52e7cf9adfed.mdx\",lineNumber:137,columnNumber:4},this)},void 0,!1,{fileName:\"/home/phi/side_projects/personal-website/mdx_contents/blog/smart_contract/_mdx_bundler_entry_point-d7acae44-c670-4980-9519-52e7cf9adfed.mdx\",lineNumber:137,columnNumber:1},this),`\n`,(0,o.jsxDEV)(n.li,{children:(0,o.jsxDEV)(n.a,{href:\"https://ethereum.org/en/developers/docs/evm/opcodes/\",children:\"Ethereum OpCodes\"},void 0,!1,{fileName:\"/home/phi/side_projects/personal-website/mdx_contents/blog/smart_contract/_mdx_bundler_entry_point-d7acae44-c670-4980-9519-52e7cf9adfed.mdx\",lineNumber:138,columnNumber:4},this)},void 0,!1,{fileName:\"/home/phi/side_projects/personal-website/mdx_contents/blog/smart_contract/_mdx_bundler_entry_point-d7acae44-c670-4980-9519-52e7cf9adfed.mdx\",lineNumber:138,columnNumber:1},this),`\n`]},void 0,!0,{fileName:\"/home/phi/side_projects/personal-website/mdx_contents/blog/smart_contract/_mdx_bundler_entry_point-d7acae44-c670-4980-9519-52e7cf9adfed.mdx\",lineNumber:136,columnNumber:1},this)]},void 0,!0,{fileName:\"/home/phi/side_projects/personal-website/mdx_contents/blog/smart_contract/_mdx_bundler_entry_point-d7acae44-c670-4980-9519-52e7cf9adfed.mdx\",lineNumber:1,columnNumber:1},this)}function hr(l={}){let{wrapper:n}=l.components||{};return n?(0,o.jsxDEV)(n,Object.assign({},l,{children:(0,o.jsxDEV)(Re,l,void 0,!1,{fileName:\"/home/phi/side_projects/personal-website/mdx_contents/blog/smart_contract/_mdx_bundler_entry_point-d7acae44-c670-4980-9519-52e7cf9adfed.mdx\"},this)}),void 0,!1,{fileName:\"/home/phi/side_projects/personal-website/mdx_contents/blog/smart_contract/_mdx_bundler_entry_point-d7acae44-c670-4980-9519-52e7cf9adfed.mdx\"},this):Re(l)}var vr=hr;function gr(l,n,m){throw new Error(\"Expected \"+(n?\"component\":\"object\")+\" `\"+l+\"` to be defined: you likely forgot to import, pass, or provide it.\"+(m?\"\\nIt\\u2019s referenced in your code at `\"+m+\"` in `/home/phi/side_projects/personal-website/mdx_contents/blog/smart_contract/_mdx_bundler_entry_point-d7acae44-c670-4980-9519-52e7cf9adfed.mdx`\":\"\"))}return pr(yr);})();\n/*! Bundled license information:\n\nreact/cjs/react-jsx-dev-runtime.development.js:\n  (**\n   * @license React\n   * react-jsx-dev-runtime.development.js\n   *\n   * Copyright (c) Facebook, Inc. and its affiliates.\n   *\n   * This source code is licensed under the MIT license found in the\n   * LICENSE file in the root directory of this source tree.\n   *)\n*/\n;return Component;"
  },
  "_id": "blog/smart_contract/private_storage.mdx",
  "_raw": {
    "sourceFilePath": "blog/smart_contract/private_storage.mdx",
    "sourceFileName": "private_storage.mdx",
    "sourceFileDir": "blog/smart_contract",
    "contentType": "mdx",
    "flattenedPath": "blog/smart_contract/private_storage"
  },
  "type": "BlogPost",
  "slug": "smart_contract/private_storage"
}